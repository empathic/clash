#!/usr/bin/env bash
set -euo pipefail

# Determine the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect OS
OS="$(uname -s)"
case "$OS" in
    Darwin)
        OS_PART="apple-darwin"
        ;;
    Linux)
        OS_PART="unknown-linux-gnu"
        ;;
    *)
        echo "Unsupported OS: $OS" >&2
        exit 1
        ;;
esac

# Detect architecture
ARCH="$(uname -m)"
case "$ARCH" in
    x86_64)
        ARCH_PART="x86_64"
        ;;
    arm64|aarch64)
        ARCH_PART="aarch64"
        ;;
    *)
        echo "Unsupported architecture: $ARCH" >&2
        exit 1
        ;;
esac

# Construct binary name and path
BINARY_NAME="clash.${ARCH_PART}-${OS_PART}"
BINARY_PATH="${SCRIPT_DIR}/${BINARY_NAME}"

if [[ ! -x "$BINARY_PATH" ]]; then
    echo "Binary not found or not executable: $BINARY_PATH" >&2
    exit 1
fi

exec "$BINARY_PATH" "$@"
