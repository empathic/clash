#!/bin/sh
# Wrapper script that selects the correct clash binary for the current platform
# For local development, use: ./scripts/setup-dev.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Check for local development binary first (symlink to cargo build output)
DEV_BINARY="$SCRIPT_DIR/clash-dev"
if [ -x "$DEV_BINARY" ]; then
    exec "$DEV_BINARY" "$@"
fi

# Fall back to platform-specific pre-built binary
OS="$(uname -s)"
case "$OS" in
    Darwin) OS_NAME="darwin" ;;
    Linux)  OS_NAME="linux" ;;
    *)
        echo "Error: Unsupported operating system: $OS" >&2
        exit 1
        ;;
esac

ARCH="$(uname -m)"
case "$ARCH" in
    arm64|aarch64) ARCH_NAME="arm64" ;;
    x86_64|amd64)  ARCH_NAME="x86_64" ;;
    *)
        echo "Error: Unsupported architecture: $ARCH" >&2
        exit 1
        ;;
esac

BINARY="$SCRIPT_DIR/clash-${OS_NAME}-${ARCH_NAME}"

if [ ! -x "$BINARY" ]; then
    echo "Error: Binary not found for platform ${OS_NAME}-${ARCH_NAME}" >&2
    echo "Expected: $BINARY" >&2
    echo "" >&2
    echo "For local development, run: ./scripts/setup-dev.sh" >&2
    echo "" >&2
    echo "Available binaries:" >&2
    ls -la "$SCRIPT_DIR"/clash-* 2>/dev/null || echo "  (none found)" >&2
    exit 1
fi

exec "$BINARY" "$@"
