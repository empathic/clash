meta:
  name: v2 policy env vars — prefix handling in Bash commands
  description: >
    Test that environment variable prefixes on Bash commands are correctly
    stripped when evaluating exec policy rules. Commands like
    `SOME_ENV=foo cargo check` should match the `cargo` allow rule.

clash:
  policy_sexpr: |
    (default deny "main")
    (policy "main"
      (allow (exec "cargo" *))
      (deny (exec "git" "push" *)))

steps:
  # Baseline: plain cargo allowed, git push denied
  - name: plain cargo build allowed (backward compat)
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: cargo build
    expect:
      decision: allow

  - name: git push denied (baseline)
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: git push origin main
    expect:
      decision: deny

  # Test 1: single env var prefix — the core bug fix
  - name: single env var prefix allows cargo check
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: SOME_ENV=foo cargo check
    expect:
      decision: allow

  # Test 2: multiple env var prefixes
  - name: multiple env var prefixes allow cargo build
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: A=1 B=2 cargo build
    expect:
      decision: allow

  # Test 3: env utility prefix
  - name: env utility prefix allows cargo test
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: env RUST_BACKTRACE=1 cargo test
    expect:
      decision: allow

  # Test 4: env var prefix on a denied command still denied
  - name: env var prefix on git push still denied
    hook: pre-tool-use
    tool_name: Bash
    tool_input:
      command: GIT_SSH=ssh git push origin main
    expect:
      decision: deny
